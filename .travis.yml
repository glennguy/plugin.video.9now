language: python
env:
  global:
    - secure: "JTL6QtfeZFmqYPIhLJvg08ksXav7PUR9kpAVknve2KimDw7a09trnHmnA1y0+9h6V+adf50Gtw8XcIuhAt2GEZyPv2a/ygoHAfSx/6SuwVqxzLUrEeunRywhDFKouxZAzrd7gzaOUt6vBmCfshne3dTqN+As9LwVEkoYHGZNRSejliZnGW5YcNFTLAQFFN2R4SMa+S+PHvPXCnLNMZ7s6wp+EMNuvex82yyEmR36cHmu+yDWdkHCvB2rFyRmw8GUVlXV5jMzgLoWywsEZqs5MBO8l0VA8T/BIAZKTYPWTV22Nq2angltK1Nz2quPSZOUMSJrm+SZONvTp6prAlKhFwqpODeQXg2+rp3fIEqG+ST/uUbAgUpzMKxQYUq4i1AMlsI9J8NvlqWOM7jSDub+QIptuajgwCF8NhifitNiKLoEiLaF9S/4oUOeAyE/b+pmsxV9Hop1zxsUYy9IwkXAjxkXF7zyz7wgwr5I6UMQ/A5YAMWRQpnnmyOE9GOXF99JB0LCQSO7jIy2JweJWLbe8jRXecYhu5+JXX1q9e2VzIDM6fAStrUROdEYGTWCLvW4gKoinWMlxBgMEMSPyw64Qa/pfbIP4ugTAWGcwqJgvHWmzjfs3dYOWQ1MoK1M1NOMkomcAwJYM8IeP17j441YzQyWsMW3WHW4vy1S5ahFlUQ="
install:
  - pip install GitPython
  - export TRAVIS_COMMIT_MSG="$TRAVIS_REPO_SLUG - $(git log --format=%B --no-merges -n 1)"
script:
  - >
    git clone https://github.com/glennguy/repo-devel.git .deploy && 
    cd .deploy && 
    ./manage_repo.py ../
  - |
    if [ -n "$TRAVIS_TAG" ]; then
        cd ..
        git clone https://github.com/glennguy/repo.git .deploy-prod && \
        cd .deploy-prod && \
        ./manage_repo.py ../ || travis_terminate 1
    fi
after_script:
  - git config --global user.email 'aussieaddons@aussieaddons.com'
  - git config --global user.name 'Aussie Add-ons Bot'
  - cd ../.deploy
  - git config credential.helper "store --file=.git/credentials"
  - echo "https://${GH_TOKEN}:@github.com" > .git/credentials
  - git add .
  - git commit --allow-empty -m "$TRAVIS_COMMIT_MSG"
  - git push
  - |
    if [ -n "$TRAVIS_TAG" ]; then
        cd ../.deploy-prod
        git config credential.helper "store --file=.git/credentials"
        echo "https://${GH_TOKEN}:@github.com" > .git/credentials
        git add . && \
        git commit --allow-empty -m "Update $(basename `git -C ../ rev-parse --show-toplevel`) to $TRAVIS_TAG" && \
        git push || travis_terminate 1
    fi
