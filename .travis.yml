language: python
env:
  global:
    - secure: "HxWN6LO5tQRseijjhckiOLVv69hm6ipCAxt0L7TRgZjBg4Q5KposOzgo42+gvE4GGJWFHO+BJ6akWBloHjr35nz17RURHtA2EJJR+tfhUeBlFOrCtrf73DkmER9nccb20lHkYAxNMxH689Vn6BY0WjhCFa4PuSRWOz6PI6OliWyuvFbBkL0Qau00XWa4EtaZKbFuyUwA0UhbSqEl0kDpFa3D8eG0SH+tHHEXu3TpW42ZFOyLd2b/rQlFfnYNe2Q2pCMTCNgKNSDlENg4aPvH2X7FLpEeoBmv1aWX4UiRXqdJf0dDt+CkGFPAOm/OZ0Z+ivWs3V2VvgRr6+UmWo1iBZU9lTMzGoxkPpgNnniK9gz8goxC4+PZ8FOJTWdkcMdcRBOBULLzG1+aWYv14eJwINcvAWkUEW0jDzobCygxNcx6tW5Wu6Gp3nT5M/XKLnft6kxEkbiS3nPYdUWJa92eoOe9eh9GUfQPBjmcOvT5/01BOBADwrm+fQOF/Dax+HbY4pDCjzQXN5YdoJb2C+5w73xBxtC4chpyqqvdh4lpKGxt9j4XNLs8JQojXt4w5p9SEcax8bI6XQlAgOGXqDGmMR630vz0RnaBFwOPz7xTdhHW7B73Xhpq6m3b5+DYGXJ0qoqNELZa7/8Yi6nyWZiMDPk8G5nvMb5ce7txfqnVsvA="
install:
  - pip install GitPython
  - export TRAVIS_COMMIT_MSG="$TRAVIS_REPO_SLUG - $(git log --format=%B --no-merges -n 1)"
script:
  - test "$TRAVIS_PULL_REQUEST" = "false" || travis_terminate 0
  - test "$TRAVIS_BRANCH" = "master" || travis_terminate 0
  - >
    git clone https://github.com/glennguy/repo-devel.git $TRAVIS_BUILD_DIR/.deploy && 
    cd $TRAVIS_BUILD_DIR/.deploy && 
    ./manage_repo.py $TRAVIS_BUILD_DIR
  - |
    if [ -n "$TRAVIS_TAG" ]; then
        git clone https://github.com/glennguy/repo.git $TRAVIS_BUILD_DIR/.deploy-prod && \
        cd $TRAVIS_BUILD_DIR/.deploy-prod && \
        ./manage_repo.py $TRAVIS_BUILD_DIR || travis_terminate 1
    fi
  - git config --global user.email 'aussieaddons@aussieaddons.com'
  - git config --global user.name 'Aussie Add-ons Bot'
  - cd $TRAVIS_BUILD_DIR/.deploy
  - git config credential.helper "store --file=.git/credentials"
  - echo "https://${GH_TOKEN}:@github.com" > .git/credentials
  - git add .
  - git commit --allow-empty -m "$TRAVIS_COMMIT_MSG"
  - git push
  - |
    if [ -n "$TRAVIS_TAG" ]; then
        cd $TRAVIS_BUILD_DIR/.deploy-prod
        git config credential.helper "store --file=.git/credentials"
        echo "https://${GH_TOKEN}:@github.com" > .git/credentials
        git add . && \
        git commit --allow-empty -m "Update $(basename `git -C $TRAVIS_BUILD_DIR rev-parse --show-toplevel`) to $TRAVIS_TAG" && \
        git push || travis_terminate 1
    fi